## Variables
```zsh
PREFIX="nicconf"
AKSNAME="nicconfaks"
PUBKEY="id_rsa.pub"
LOCATION="northeurope"
```



## Create Cluster (both primary and secondary with different name)
```zsh
AKSCLUSTER=$(az aks create \
  --node-vm-size Standard_DS3_v2 -g $PREFIX -n $AKSNAME\
  --enable-managed-identity --node-count 1 \
  --enable-addons monitoring \
  --ssh-key-value  $PUBKEY )
echo -E "$AKSCLUSTER" | jq  .name
```

## Get context for kubectl
```zsh
az aks get-credentials --overwrite-existing  --resource-group $PREFIX --name $AKSNAME
```

## Setting up ingress controller
<https://learn.microsoft.com/en-us/azure/aks/ingress-basic?tabs=azure-cli>
```zsh
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
```

## Setting up ingress controller
```zsh
NAMESPACE=ingress-basic
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --create-namespace \
  --namespace $NAMESPACE \
  --set controller.service.type=NodePort \
  --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz
```

## Checking ingress class
```zsh
kubectl --namespace ingress-basic get services -o wide  ingress-nginx-controller
kubectl get ingressclass
```

## Port forward
Execute in a second terminal (will run until stopped with ctrl+c)
```zsh
kubectl --namespace ingress-basic \
  port-forward service/ingress-nginx-controller \
  8888:443
```

## Installing the application
<https://github.com/tdewin/stock-demo>
```zsh
export stockn="stock-demo"
kubectl  create ns $stockn
```

## Install postgres chart
```zsh
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
helm install -n $stockn stockdb bitnami/postgresql \
 --set global.postgresql.auth.username=root\
 --set global.postgresql.auth.password=notsecure\
 --set global.postgresql.auth.database=stock\

```

## Installing the frontend
```zsh
GITHUB="https://raw.githubusercontent.com"
RAWURL="$GITHUB/tdewin/stock-demo/main/kubernetes"
kubectl -n $stockn apply -f "$RAWURL/deployment.yaml"
kubectl -n $stockn apply -f "$RAWURL/sec-nolb.yaml"
kubectl -n $stockn apply -f "$RAWURL/ingress.yaml"
```

## Port forwarding to ingress
```zsh
echo "https://localhost:8888/stock"
```

## Volumesnapshot class create
```zsh
cat << EOF > volumesnapshotclass.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-default
  annotations:
    k10.kasten.io/is-snapshot-class: "true"
driver: disk.csi.azure.com
deletionPolicy: Delete
parameters:
  incremental: "true"
EOF
```

## Apply File
```zsh
kubectl apply -f volumesnapshotclass.yaml && kubectl get volumesnapshotclass
```

## Validating Kasten
```zsh
helm repo add kasten https://charts.kasten.io/
curl https://docs.kasten.io/tools/k10_primer.sh | bash
```

## Create Kasten Installation
https://docs.kasten.io/latest/install/azure/azure.html
```zsh
export k10n="kasten-io"
helm install k10 kasten/k10 --create-namespace \
  --namespace=$k10n \
  --set ingress.create=true \
  --set ingress.class=nginx \
  --set auth.tokenAuth.enabled=true \
  --set azure.useDefaultMSI=true
```

## Validate install
```zsh
kubectl get pod -n $k10n -w
```

## Port forwarding to ingress
```zsh
echo "https://localhost:8888/k10/?page=Login#/login"
```

## Create a token
```zsh
kubectl get sa
kubectl get rolebinding
TOKEN=$(kubectl create token --duration=8h k10-k10)
echo $TOKEN | cut -c1-100 && echo "...."
echo $TOKEN | pbcopy #pbcopy is macos only, consider clip for windows
```

## Creating a storage account
```zsh
SA=$(az storage account create \
  --name "$PREFIX$(($(date +%s)%10000))" \
  --resource-group $PREFIX \
  --location $LOCATION \
  --sku Standard_RAGRS \
  --kind StorageV2 \
  --allow-blob-public-access false\
  -o json)
STORAGEACCOUNT=$(echo $SA | jq -r .name)
echo $STORAGEACCOUNT
```

## Creating a container
```zsh
CONT=$(az storage container create \
    --name $PREFIX \
    --account-name $STORAGEACCOUNT \
    --auth-mode login)
echo $CONT
echo $PROJECT
```

## Get the key
```zsh
KEYS=$(az storage account keys list \
  --resource-group $PREFIX \
  --account-name $(echo $SA | jq -r .name) \
  -o json)
PASS=$(echo $KEYS | jq -r '.[0].value')
echo $PASS | cut -c1-10
echo "sa: $STORAGEACCOUNT container: $PROJECT"
echo $PASS | pbcopy #pbcopy is mac thing
```

Attach the storage account in the GUI under locations : <https://docs.kasten.io/latest/usage/configuration.html#azure-storage>

# Create policy 
Make sure to set export to Azure storage : <https://docs.kasten.io/latest/usage/protect.html#backups>

On the secondary cluster installation create import policy based on the import details: <https://docs.kasten.io/latest/usage/migration.html#importing-applications>

Restore the application generated by the first installation: <https://docs.kasten.io/latest/usage/restore.html#restoring-deleted-applications>
